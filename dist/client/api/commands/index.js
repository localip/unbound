"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),!function _export(a,b){for(var c in b)Object.defineProperty(a,c,{enumerable:!0,get:b[c]})}(exports,{commands:()=>s,section:()=>t,initialize:()=>initialize,shutdown:()=>shutdown,register:()=>register,unregister:()=>unregister});const a=require("../../../common/logger"),b=require("@webpack"),c=require("../../modules/webpack/api"),d=require("../../../common/utilities/index"),e=require("../../modules/patcher/index"),f=_interopRequireDefault(require("../../core/commands")),g=_interopRequireDefault(require("../clyde")),h=_interopRequireDefault(require("react")),i=_interopRequireDefault(require("./components/SectionIcon"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}const j=(0,a.createLogger)("API","Commands"),k=(0,e.create)("unbound-commands"),[l,m,n,o,p,q,r]=(0,b.bulk)(b.filters.byProps("getBuiltInCommands"),b.filters.byProps("getApplicationIconURL"),b.filters.byProps("useSearchManager"),a=>!a.mask&&a.icon&&a.selectable&&a.wrapper,b.filters.byDisplayName("ApplicationCommandDiscoverySectionIcon",!1),b.filters.byDisplayName("ApplicationCommandItem",!1),a=>a.type?.displayName==="ChannelApplicationIcon"),s=new Map,t={id:"unbound",type:0,name:"Unbound",icon:"https://github.com/unbound-mod.png"};function initialize(){register(...f.default);try{k.before(r,"type",(a,[b])=>{!b.section&&b.command.__unbound&&(b.section=t)})}catch(a){j.error("Failed to patch ChannelApplicationIcon: ",a)}try{k.before(q,"default",(a,[b])=>{!b.section&&b.command.__unbound&&(b.section=t)})}catch(b){j.error("Failed to patch ApplicationCommandItem: ",b)}try{k.instead(p,"default",(a,b,c)=>{let[e]=b,f=void 0===e.selectable;if(e.section.id===t.id){let g=(0,d.classnames)(o.wrapper,e.selectable&&o.selectable,e.selectable&&e.isSelected&&o.selected);return h.default.createElement("div",{className:g},h.default.createElement(i.default,{width:e.width,height:e.height,className:(0,d.classnames)(o.icon,e.className),style:{width:`${e.width}px`,height:`${e.height}px`,padding:f?0:"4px",paddingBottom:f?0:"1px"}}))}return c.apply(a,b)})}catch(c){j.error("Failed to patch ApplicationCommandDiscoverySectionIcon: ",c)}try{l.BUILT_IN_SECTIONS.unbound=t}catch(e){j.error("Failed to push section to BUILT_IN_SECTIONS: ",e)}try{k.instead(m,"getApplicationIconURL",(a,b,c)=>b[0]?.id===t.id?t.icon:c.apply(a,b))}catch(g){j.error("Failed to patch getApplicationIconURL: ",g)}try{k.instead(n.default,"getApplicationSections",(a,b,c)=>{try{let d=c.apply(self,b)??[];return d.find(a=>a.id===t.id)||d.push(t),d}catch{return[]}})}catch(u){j.error("Failed to patch getApplicationSections: ",u)}try{k.after(n.default,"getQueryCommands",(a,[,,b],c)=>{if(!(!b||b.startsWith("/"))){for(let d of(c??=[],s.values()))if(!(!~d.name?.indexOf(b)||c.some(a=>a.__unbound&&a.id===d.id)))try{c.unshift(d)}catch{c=[...c,d]}}})}catch(v){j.error("Failed to patch getQueryCommands: ",v)}try{k.after(n,"useSearchManager",(a,[,b],c)=>{if(1!==b||!s.size)return;c.sectionDescriptors?.find?.(a=>a.id===t.id)||(c.sectionDescriptors??=[],c.sectionDescriptors.push(t)),c.filteredSectionId&&c.filteredSectionId!==t.id||c.activeSections.find(a=>a.id===t.id)||c.activeSections.push(t);let d=[...s.values()];if(d.some(a=>!c.commands?.find?.(b=>b.id===a.id))){c.commands??=[];let e=[...c.commands,...d];c.commands=[...new Set(e).values()]}c.filteredSectionId&&c.filteredSectionId!==t.id||c.commandsByActiveSection.find(a=>a.section.id===t.id)||c.commandsByActiveSection.push({section:t,data:[...d.values()]});let f=c.commandsByActiveSection.find(a=>a.section.id===t.id);(!c.filteredSectionId||c.filteredSectionId===t.id)&&f&&0===f.data.length&&0!==s.size&&(f.data=[...s.values()]);let g=c.sectionDescriptors.filter(a=>"-1"===a.id);g.length>1&&(c.sectionDescriptors=c.sectionDescriptors.filter(a=>"-1"!==a.id),c.sectionDescriptors.push(g.find(a=>"-1"===a.id)))})}catch(w){j.error("Failed to patch useSearchManager: ",w)}}function shutdown(){f.default.map(a=>unregister(a.name));try{delete l.BUILT_IN_SECTIONS.unbound}catch(a){j.error("Failed to remove section from BUILT_IN_SECTIONS: ",a)}k.unpatchAll()}function register(...a){for(let b of a){let{name:d,description:e,execute:f,...h}=b;if(!d||!e)return;s.set(d,{type:3,target:1,id:d,name:d,displayName:d,displayDescription:e,applicationId:t.id,options:[],__unbound:!0,listed:!0,dmPermission:!0,execute(...a){let b=f?.(...a);if("object"==typeof b&&!Array.isArray(b))return b.send?(c.Messages.sendMessage(a[1].channel.id,{invalidEmojis:[],tts:!1,validNonShortcutEmojis:[],...b}),void 0):g.default.send(b);return b},...h})}}function unregister(a){s.delete(a)}