"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),!function _export(a,b){for(var c in b)Object.defineProperty(a,c,{enumerable:!0,get:b[c]})}(exports,{commands:()=>p,section:()=>q,initialize:()=>initialize,shutdown:()=>shutdown,register:()=>register,unregister:()=>unregister});const a=require("../../../common/logger"),b=require("@webpack"),c=require("../../../common/utilities/index"),d=require("../../modules/patcher/index"),e=_interopRequireDefault(require("react")),f=_interopRequireDefault(require("./components/SectionIcon"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}const g=(0,a.createLogger)("API","Commands"),h=(0,d.create)("unbound-commands"),[i,j,k,l,m,n,o]=(0,b.bulk)(b.filters.byProps("getBuiltInCommands"),b.filters.byProps("getApplicationIconURL"),b.filters.byProps("useSearchManager"),a=>!a.mask&&a.icon&&a.selectable&&a.wrapper,b.filters.byDisplayName("ApplicationCommandDiscoverySectionIcon",!1),b.filters.byDisplayName("ApplicationCommandItem",!1),a=>a.type?.displayName==="ChannelApplicationIcon"),p=new Map,q={id:"unbound",type:0,name:"Unbound",icon:"https://github.com/unbound-mod.png"};function initialize(){try{h.before(o,"type",(a,[b])=>{!b.section&&b.command.__unbound&&(b.section=q)})}catch(a){g.error("Failed to patch ChannelApplicationIcon: ",a)}try{h.before(n,"default",(a,[b])=>{!b.section&&b.command.__unbound&&(b.section=q)})}catch(b){g.error("Failed to patch ApplicationCommandItem: ",b)}try{h.instead(m,"default",(a,b,d)=>{let[g]=b,h=void 0===g.selectable;if(g.section.id===q.id){let i=(0,c.classnames)(l.wrapper,g.selectable&&l.selectable,g.selectable&&g.isSelected&&l.selected);return e.default.createElement("div",{className:i},e.default.createElement(f.default,{width:g.width,height:g.height,className:(0,c.classnames)(l.icon,g.className),style:{width:`${g.width}px`,height:`${g.height}px`,padding:h?0:"4px",paddingBottom:h?0:"1px"}}))}return d.apply(a,b)})}catch(d){g.error("Failed to patch ApplicationCommandDiscoverySectionIcon: ",d)}try{i.BUILT_IN_SECTIONS.unbound=q}catch(r){g.error("Failed to push section to BUILT_IN_SECTIONS: ",r)}try{h.instead(j,"getApplicationIconURL",(a,b,c)=>b[0]?.id===q.id?q.icon:c.apply(a,b))}catch(s){g.error("Failed to patch getApplicationIconURL: ",s)}try{h.instead(k.default,"getApplicationSections",(a,b,c)=>{try{let d=c.apply(self,b)??[];return d.find(a=>a.id===q.id)||d.push(q),d}catch{return[]}})}catch(t){g.error("Failed to patch getApplicationSections: ",t)}try{h.after(k.default,"getQueryCommands",(a,[,,b],c)=>{if(!(!b||b.startsWith("/"))){for(let d of(c??=[],p.values()))if(!(!~d.name?.indexOf(b)||c.some(a=>a.__unbound&&a.id===d.id)))try{c.unshift(d)}catch{c=[...c,d]}}})}catch(u){g.error("Failed to patch getQueryCommands: ",u)}try{h.after(k,"useSearchManager",(a,[,b],c)=>{if(1!==b||!p.size)return;c.sectionDescriptors?.find?.(a=>a.id===q.id)||(c.sectionDescriptors??=[],c.sectionDescriptors.push(q)),c.filteredSectionId&&c.filteredSectionId!==q.id||c.activeSections.find(a=>a.id===q.id)||c.activeSections.push(q);let d=[...p.values()];if(d.some(a=>!c.commands?.find?.(b=>b.id===a.id))){c.commands??=[];let e=[...c.commands,...d];c.commands=[...new Set(e).values()]}c.filteredSectionId&&c.filteredSectionId!==q.id||c.commandsByActiveSection.find(a=>a.section.id===q.id)||c.commandsByActiveSection.push({section:q,data:[...d.values()]});let f=c.commandsByActiveSection.find(a=>a.section.id===q.id);(!c.filteredSectionId||c.filteredSectionId===q.id)&&f&&0===f.data.length&&0!==p.size&&(f.data=[...p.values()]);let g=c.sectionDescriptors.filter(a=>"-1"===a.id);g.length>1&&(c.sectionDescriptors=c.sectionDescriptors.filter(a=>"-1"!==a.id),c.sectionDescriptors.push(g.find(a=>"-1"===a.id)))})}catch(v){g.error("Failed to patch useSearchManager: ",v)}}function shutdown(){try{delete i.BUILT_IN_SECTIONS.unbound}catch(a){g.error("Failed to remove section from BUILT_IN_SECTIONS: ",a)}h.unpatchAll()}function register(a){let{command:b,name:c,description:d,executor:e,...f}=a;(b||c)&&d&&p.set(b,{type:3,target:1,id:b||c,name:b||c,displayName:b||c,displayDescription:d,applicationId:q.id,options:[],__unbound:!0,listed:!0,dmPermission:!0,executor(){},...f})}function unregister(a){p.delete(a)}